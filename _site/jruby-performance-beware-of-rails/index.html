<!DOCTYPE html>
<html class="no-js">

  <head>
	<meta charset="utf-8">
	<title>JRuby Performance: Beware of Rails deprecated warnings | Sorted Array</title>
	<meta name="description" content="We recently upgraded our JRuby version from 1.3.x to 1.7.12 and suddenly noticed a huge regression in performance. Our requests were starting to slow down by...">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	
	<!-- CSS -->
	<link rel="stylesheet" href="/css/main.css">
	
	<!--Favicon-->
	<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
	
	<!-- Canonical -->
	<link rel="canonical" href="http://www.sortedarray.com/jruby-performance-beware-of-rails">
	
	<!-- RSS -->
	<link rel="alternate" type="application/atom+xml" title="Sorted Array" href="http://www.sortedarray.com/feed.xml" />
	
	<!-- Font Awesome -->
	<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
	
	<!-- Google Fonts -->
	<link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,700italic,400italic" rel="stylesheet" type="text/css">
	
	<!-- Google Analytics -->
	
</head>


  <body>
    <header class="site-header">

	<div class="branding">
		
		<img class="avatar" src="/img/avatar.png" alt=""/>
		
		
		<h1 class="site-title">
			<a href="/">Sorted Array</a>
		</h1>
	</div>
	
	<nav class="site-nav">
		<ul>
			
				
				<li>
					<a class="page-link" href="/all_posts/">All Posts</a>
				</li>
				
			
				
				<li>
					<a class="page-link" href="/about/">About</a>
				</li>
				
			
				
				<li>
					<a class="page-link" href="/contact/">Contact Me</a>
				</li>
				
			
				
			
				
			
				
			
				
			

			<!-- Social icons from Font Awesome, if enabled -->
			
<li>
	<a href="http://www.sortedarray.com/feed.xml" title="Follow RSS feed">
		<i class="fa fa-fw fa-rss"></i>
	</a>
</li>



<li>
	<a href="mailto:basit.hanif@gmail.com" title="Email">
		<i class="fa fa-fw fa-envelope"></i>
	</a>
</li>













<li>
	<a href="https://github.com/amunda" title="Follow on GitHub">
		<i class="fa fa-fw fa-github"></i>
	</a>
</li>





















<li>
	<a href="https://twitter.com/amunda" title="Follow on Twitter">
		<i class="fa fa-fw fa-twitter"></i>
	</a>
</li>





		</ul>
	</nav>
	
</header>


    <div class="content">
      <article >

  <header style="background-image: url('/')">
    <h1 class="title">JRuby Performance: Beware of Rails deprecated warnings</h1>
    
    <p class="meta">
    August 11, 2014
     - {"login"=>"amunda", "email"=>"basit.hanif@gmail.com", "display_name"=>"amunda", "first_name"=>"", "last_name"=>""}
    </p>
  </header>

  <section class="post-content">
    <p>We recently upgraded our JRuby version from 1.3.x to 1.7.12 and suddenly noticed a huge regression in performance. Our requests were starting to slow down by 500 ms and that was huge for our customers.</p>
<p>We investigate what could be the potential issue and we used some low level tools like jstack to really nail down where threads were spending most of the time. After investigating, we saw that in our call trace lot of Thread.getStackTrace() calls were made by the app. This is an expensive call in Java.</p>
<p>We looked closely of where the calls were coming from and found out that deprecated warnings in Rails methods were causing these calls. Our first thought was that we will just disable the deprecated warnings in Rails by using this flag:</p>
<pre class="lang:ruby decode:true ">ActiveSupport::Deprecation.silenced =true</pre>
<p>But we still continue to see getStackTrace calls in our call traces. We further dig down in Rails code and found out that it was the Kernel 'caller' method which was the culprit.</p>
<pre class="lang:default decode:true">ActiveSupport::Deprecation.warn "Calling `assign_shortcuts` is deprecated and has no effect anymore.", caller</pre>
<p>Caller method in JRuby will call the getStackTrace method and this was used by 'ActiveSupport::Deprecation.warn' method to report the exact line of the offending method.</p>
<p>Since it was passed in as an argument to deprecated warnings method, logic for switching on/off deprecated warnings has no effect. So the 'silenced' flag didn't help at all.</p>
<p>So our solution was to fix all the deprecated warnings and wherever we couldn't fix the warnings, we had to monkey patch Rails and completely remove the deprecated method call from the method.</p>
<p>So please beware of Rails deprecated warnings in JRuby!</p>

  </section>

  <!-- Disqus -->
  
  
</article>
    </div>

    
  </body>
  
</html>
